{{ header }}
<div class="container">
  <div class="row">
    <div class="col-md-8 col-md-offset-2">

      <fieldset class="step-heading">
        <h1><small>Step 1 /</small> {{ heading_title }}</h1>
        <h3>{{ text_upgrade }}</h3>
      </fieldset>
      {{ column_left }}


      <fieldset>
        <div class="description">{{ text_server }}</div>
        <ol>
          <li>{{ text_error }}</li>
          <li>{{ text_clear }}</li>
          <li>{{ text_admin }}</li>
          <li>{{ text_user }}</li>
          <li>{{ text_setting }}</li>
          <li>{{ text_store }}</li>
        </ol>
      </fieldset>
      
      <fieldset>
        <div class="description">{{ text_steps }}</div>
        <div class="form-group">
          <label class="col-sm-2 control-label">{{ entry_progress }}</label>
          <div class="col-sm-10">
            <div class="progress">
              <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
            </div>
            <div id="progress-text"></div>
          </div>
        </div>
      </fieldset>

      <div class="buttons">
        <div class="text-right">
          <input type="submit" value="{{ button_continue }}" id="button-continue" class="btn btn-primary" />
        </div>
      </div>
      <hr/>
    </div>
  </div>
  <script type="text/javascript"><!--
    var step = 0;

    $('#button-continue').on('click', function() {
    	$('#progress-bar').addClass('progress-bar-success').css('width', '0%').removeClass('progress-bar-danger');
    	$('#progress-text').html('');
    	$('#button-continue').prop('disabled', true).before('<i class="fa fa-spinner fa-spin"></i> ');

    	start('index.php?route=upgrade/upgrade/next');
    });

    function start(url) {
    	setTimeout(function(){
    		$.ajax({
    			url: url,
    			type: 'post',
    			dataType: 'json',
    			success: function(json) {
    				if (json['error']) {
    					$('#progress-bar').addClass('progress-bar-danger');
    					$('#progress-text').html('<div class="text-danger">' + json['error'] + '</div>');

    					$('#button-continue').prop('disabled', false);
    					$('.fa-spinner').remove();
    				}

    				if (json['success']) {
    					$('#progress-text').html('<span class="text-success">' + json['success'] + '</span>');
    					$('#progress-bar').css('width', ((step / {{ total }}) * 100) + '%');
    				}

    				if (json['next']) {
    					start(json['next']);
    				} else if (!json['error']) {
    					$('#button-continue').replaceWith('<a href="{{ store }}" class="btn btn-primary">{{ button_continue }}</a>');
    					$('.fa-spinner').remove();
    				}

    				step++;
    			},
    			error: function(xhr, ajaxOptions, thrownError) {
    				$('#progress-bar').addClass('progress-bar-danger');
    				$('#progress-text').html('<div class="text-danger">' + (thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText) + '</div>');
    				$('#button-continue').prop('disabled', false);
    				$('.fa-spinner').remove();
    			}
    		});
    	}, 1000);
    }
  //-->
  </script>
</div>

{{ footer }}
